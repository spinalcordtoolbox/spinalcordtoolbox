Bootstrap: docker
From: ubuntu:22.04

%arguments
    # A list of sct_deepseg tasks you want installed immediately, w/o needing to repack the container later
    task_installs=''

%environment
    # Update the PATH so that SCT commands are always available
    export PATH=$PATH:/sct/bin

%post
    # Install our non-Python dependencies
    apt-get update
    apt-mark hold openssh-client dbus  # Pinning these so that it doesn't crash due to this: https://github.com/apptainer/apptainer/issues/1822#issuecomment-2051581258
    apt-get install -y git wget bzip2 libglib2.0-0 libgl1-mesa-glx libxrender1 libxkbcommon-x11-0 libdbus-1-3 gcc

    # Clone the master branch of the SCT repository
    git clone https://github.com/spinalcordtoolbox/spinalcordtoolbox.git sct
    cd sct

    # Install it into this container
    ./install_sct -y

    # If any tasks were designated by the user, install their corresponding models
    if [ "{{ task_installs }}" != '' ]; then
        # Add SCT's bin to PATH for easy access
        export PATH=$PATH:/sct/bin
        # Install each task requested by the user, one by one
        for task in {{ task_installs }}; do
            sct_deepseg "$task" -install
        done
    fi


%help
    This container has the barebones, default installation of the latest master branch of the Spinal Cord Toolbox.
    It contains only the default models unless you specify others with the `--build-arg task_installs="{task_list}"`
    argument; `sct_deepsge -install` will NOT work due to the network isolation of apptainer containers post-install.
