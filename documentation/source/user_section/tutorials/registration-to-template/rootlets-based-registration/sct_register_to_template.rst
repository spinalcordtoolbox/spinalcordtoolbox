Registration algorithm: ``sct_register_to_template -lrootlet``
##############################################################

Traditional template-based registration of the spinal cord uses intervertebral discs for alignment. However, substantial anatomical variability across individuals exists between vertebral and spinal levels. Spinal nerve rootlets, which are more consistent across individuals, can be used instead to improve registration accuracy `(Bedard & al, 2025) <https://doi.org/10.1162/IMAG.a.123>`__.


..  TODO change figure
.. figure:: https://raw.githubusercontent.com/spinalcordtoolbox/doc-figures/blob/sb/add-fig-rootlets-reg/rootlets-based-registration/rootlets-reg-pipeline.png
   :align: right
   :figwidth: 300px

   Rootlets-based registration pipeline.

SCT provides the :ref:`sct_register_to_template` command for template registration based on spinal nerve rootlets. Here are the steps for the algorithm within this command:

1. **Center-of-mass calculation:**: The center-of-mass of each segmented rootlets level is computed for the subject native image and for the PAM50 template.
2. **Straightening**: The straightening works by finding, for each point along the spinal cord, the mathematical transformation to go from a curved centerline to a straight centerline.
3. **Initial alignment of rootlets levels**: Once straightened, the next step involves a transformation to match the vertebral levels of the subject to that of the template. If 2 labels are provided, this transformation will be affine; if 3+ labels are provided, this transformation will be non-affine. (Note: This step focuses only on matching the coordinates of the labels, and does not consider the shape of the spinal cord, which is handled by the next step.)
4. **Non-linear registration in rostro-caudal axis**: BSplineSyn registration is applied along the rostro-caudal axis using the rootlet segmentation as a mask on both subject and PAM50 T2w images
5. **Processing of warping field**: The resulting warping field from the rostro-caudal alignment (step 4) is averaged slice-wise to ensure right-left symmetry (step 5). The mean is calculated excluding zero values.
6. **Shape-matching transformation**: A multi-step nonrigid deformation is estimated to match the subjectâ€™s cord shape to the template. By default, two steps are used: the first handles large deformations, while the second applies fine adjustments.
7. **Warping field concatenation**: The forward and backward transformations to the PAM50 template are generated by concatenating the warping fields from steps 2, 3, 5 et 6
.. warning::

   You can visit the :ref:`customizing-registration-section` page to learn how to optimize the registration procedure for your particular contrast, resolution, and spinal cord geometry.
