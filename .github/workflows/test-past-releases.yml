name: Test past releases

on:
  schedule:
    # https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#onschedule
    # > Scheduled workflows run on the latest commit on the default or base branch
    # i.e. this can only run on master
    - cron:  '0 11 * * *'
  pull_request:
    # JUST TEMPORARY UNTIL THIS PR IS MERGED
    branches:
      - '*'
env:
    # Even when given -y, apt will still sometimes hang at a prompt if a package
    # has clarifications to ask; DEBIAN_FRONTEND=noninteractive prevents that,
    # This will be defined for non-debian platforms below too, but there's no harm in that.
    # (TravisCI quietly defined this on all their platforms, but we have to give it manually on GithubCI.)
    DEBIAN_FRONTEND: 'noninteractive'
    # Turns on color output for pytest. See: https://github.com/pytest-dev/pytest/issues/7443#issuecomment-656642591
    PY_COLORS: "1"
    # Disable progress bars for less verbose output
    PIP_PROGRESS_BAR: "off"
    SCT_PROGRESS_BAR: "off"

jobs:

  test_past_releases:
    name: Test past releases
    strategy:
      fail-fast: false
      matrix:
        sct_version: [ "6.5", "6.4", "6.3", "6.2", "6.1", "6.0", "5.8", "5.7", "5.6", "5.5", "5.4", "5.3.0", "5.2.0", "5.1.0" ]
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        exclude:
          # Windows support was only properly introduced in 5.7
          - sct_version: "5.6"
            os: windows-latest
          - sct_version: "5.5"
            os: windows-latest
          - sct_version: "5.4"
            os: windows-latest
          - sct_version: "5.3.0"
            os: windows-latest
          - sct_version: "5.2.0"
            os: windows-latest
          - sct_version: "5.1.0"
            os: windows-latest
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ matrix.sct_version }}

      - name: Install SCT (Unix)
        if: runner.os != 'Windows'
        run: ./install_sct -y

      - name: Install SCT (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: install_sct.bat

      - name: Update environment variables
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then

            # NB: I'm not sure what GHA's syntax is for cmd.exe, so we use bash to set the environment variables.
            # In a user install, the user would perform this step using the Windows environment variable changing GUI.
            echo "SCT_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
            echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

          else

            # NB: install_sct edits ~/.bashrc, but those environment changes don't get passed to subsequent steps in GH Actions.
            # So, we filter through the .bashrc and pass the values to $GITHUB_ENV and $GITHUB_PATH.
            # Relevant documentation: https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#environment-files
            # This workaround should be replaced by https://github.com/spinalcordtoolbox/spinalcordtoolbox/pull/3198#discussion_r568225392
            cat ~/.bashrc | grep "export SCT_DIR" | cut -d " " -f 2 >> $GITHUB_ENV
            cat ~/.bashrc | grep "export PATH" | grep -o "/.*" | cut -d ':' -f 1 >> $GITHUB_PATH

          fi

      - name: Check dependencies
        run: sct_check_dependencies

      - name: Run tests
        run: sct_testing
